openapi: 3.0.3
info:
  title: Home Energy API
  description: |
    Secure bridge between a frontend dashboard and Home Assistant.
    This API proxies energy data from Home Assistant, enforcing entity allowlists
    and API key authentication.
  version: 1.0.1
  contact:
    name: API Support

servers:
  - url: http://localhost:3000
    description: Local development server

security: []

paths:
  /health:
    get:
      summary: Health check
      description: Returns the health status of the API
      operationId: getHealth
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                ok: true

  /api/energy/summary:
    get:
      summary: Get current energy summary
      description: |
        Returns a snapshot of current power readings, today's energy usage,
        and current tariff information.
      operationId: getEnergySummary
      tags:
        - Energy
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Energy summary data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnergySummary'
              example:
                now:
                  import_w: 450
                  solar_w: 2850
                  house_w: 1200
                  car_charging: false
                today:
                  kwh: 12.4
                  cost_gbp: 2.85
                tariff:
                  window: peak
                  unit_rate_p: 24.5
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '502':
          $ref: '#/components/responses/BadGateway'

  /api/energy/timeseries:
    get:
      summary: Get historical timeseries data
      description: |
        Returns historical data points for a specific entity over the requested
        time range, resampled to the requested interval.
      operationId: getEnergyTimeseries
      tags:
        - Energy
      security:
        - ApiKeyAuth: []
      parameters:
        - name: entity_id
          in: query
          required: true
          description: Home Assistant entity ID (must be in ALLOWED_ENTITIES)
          schema:
            type: string
          example: sensor.grid_import_power
        - name: range
          in: query
          required: false
          description: Time range to fetch
          schema:
            type: string
            enum: ['1h', '6h', '12h', '24h', '7d']
            default: '24h'
        - name: interval
          in: query
          required: false
          description: Data point interval
          schema:
            type: string
            enum: ['1m', '5m', '15m', '30m', '1h']
            default: '5m'
      responses:
        '200':
          description: Timeseries data points
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimeseriesResponse'
              example:
                metric: Grid Import
                unit: W
                points:
                  - t: '2024-01-15T10:00:00.000Z'
                    v: 450
                  - t: '2024-01-15T10:05:00.000Z'
                    v: 480
                  - t: '2024-01-15T10:10:00.000Z'
                    v: 420
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '502':
          $ref: '#/components/responses/BadGateway'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: Dashboard API key for authentication

  schemas:
    HealthResponse:
      type: object
      required:
        - ok
      properties:
        ok:
          type: boolean
          description: Whether the service is healthy

    EnergySummary:
      type: object
      required:
        - now
        - today
        - tariff
      properties:
        now:
          type: object
          required:
            - import_w
            - solar_w
            - house_w
            - car_charging
          properties:
            import_w:
              type: number
              description: Current grid import power in watts
            solar_w:
              type: number
              description: Current solar generation in watts
            house_w:
              type: number
              description: Current house consumption in watts
            car_charging:
              type: boolean
              description: Whether the car charger is active
        today:
          type: object
          required:
            - kwh
            - cost_gbp
          properties:
            kwh:
              type: number
              description: Total energy consumed today in kWh
            cost_gbp:
              type: number
              description: Total cost today in GBP
        tariff:
          type: object
          required:
            - window
            - unit_rate_p
          properties:
            window:
              type: string
              enum:
                - peak
                - offpeak
              description: Current tariff window
            unit_rate_p:
              type: number
              description: Current unit rate in pence per kWh

    TimeseriesResponse:
      type: object
      required:
        - metric
        - unit
        - points
      properties:
        metric:
          type: string
          description: Human-readable metric name
        unit:
          type: string
          description: Unit of measurement
        points:
          type: array
          items:
            $ref: '#/components/schemas/TimeseriesPoint'

    TimeseriesPoint:
      type: object
      required:
        - t
        - v
      properties:
        t:
          type: string
          format: date-time
          description: Timestamp in ISO8601 format
        v:
          type: number
          description: Value at this timestamp

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error type
        message:
          type: string
          description: Human-readable error message

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Bad Request
            message: Invalid query parameters

    Unauthorized:
      description: Missing API key
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Unauthorized
            message: Missing X-API-Key header

    Forbidden:
      description: Invalid API key or entity not allowed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Forbidden
            message: Invalid API key

    BadGateway:
      description: Failed to communicate with Home Assistant
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Bad Gateway
            message: Failed to fetch data from Home Assistant

tags:
  - name: Health
    description: Health check endpoints
  - name: Energy
    description: Energy data endpoints
